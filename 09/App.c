/*********************************************************************************************************
* 模块名称: App.c
* 摘    要: 
* 当前版本: 
* 作    者: 
* 完成日期: 
* 内    容:
* 注    意:                                                                   
**********************************************************************************************************
* 取代版本: 
* 作    者:
* 完成日期: 
* 修改内容:
* 修改文件: 
*********************************************************************************************************/

/*********************************************************************************************************
*                                              包含头文件
*********************************************************************************************************/
#include <stdio.h>
#include <windows.h>
#pragma comment(lib, "winmm.lib")  //导入window.lib多媒体库

#include "CalcTime.h"
#include "Tick.h"
/*********************************************************************************************************
*                                              宏定义
*********************************************************************************************************/

/*********************************************************************************************************
*                                              枚举结构体定义
*********************************************************************************************************/

/*********************************************************************************************************
*                                              内部变量
*********************************************************************************************************/

/*********************************************************************************************************
*                                              内部函数声明
*********************************************************************************************************/
static void InitSoftware(void);     //初始化 Software

static void __stdcall TimeProc(UINT uTimerID, UINT uMsg, DWORD_PTR dwUser,
                               DWORD_PTR dw1, DWORD_PTR dw2);    //定时器回调函数

static void Proc2msTask(void);      // 声明一个2ms执行一次的函数
static void Proc1SecTask(void);     // 声明一个1sec执行一次的函数
/*********************************************************************************************************
*                                              内部函数实现
*********************************************************************************************************/
/*********************************************************************************************************
* 函数名称: InitSoftware
* 函数功能: 所有软件初始化都放在此函数中
* 输入参数: void
* 输出参数: void
* 返 回 值: void
* 创建日期: 
* 注    意: 
*********************************************************************************************************/
static void InitSoftware(void) {
    InitCalcTime();
    InitTick();

    SetTickVal(80000);      // 设定初始化时间
}
/*********************************************************************************************************
* 函数名称: TimeProc
* 函数功能: 定时器回调函数
* 输入参数: uTimerID, uMsg, dwUser, dw1, dw2
* 输出参数: void
* 返 回 值: void
* 创建日期:
* 注    意:
*********************************************************************************************************/
static void __stdcall TimeProc(UINT uTimerID, UINT uMsg, DWORD_PTR dwUser,
                               DWORD_PTR dw1, DWORD_PTR dw2) {
    Proc2msTask();
}
/*********************************************************************************************************
* 函数名称: Proc2msTask
* 函数功能: 处理2ms任务
* 输入参数: void
* 输出参数: void
* 返 回 值: void
* 创建日期:
* 注    意:
*********************************************************************************************************/
static void Proc2msTask(void) {
    static short s_iCnt500 = 0;

    TickPer2Ms();

    if(s_iCnt500 >= 499) {
        Proc1SecTask();
        s_iCnt500 = 0;
    }
    else {
        s_iCnt500++;
    }
}
/*********************************************************************************************************
* 函数名称: Proc1SecTask
* 函数功能: 处理1sec任务
* 输入参数: void
* 输出参数: void
* 返 回 值: void
* 创建日期:
* 注    意:
*********************************************************************************************************/
static void Proc1SecTask(void) {
    int tickVal;
    short hour, min, sec;

    tickVal = GetTickVal();

    hour = CalcTime(tickVal, TIME_VAL_HOUR);
    min = CalcTime(tickVal, TIME_VAL_MIN);
    sec = CalcTime(tickVal, TIME_VAL_SEC);

    printf("Current time: %02d-%02d-%02d\n", hour, min, sec);
}

/*********************************************************************************************************
*                                              API函数实现
*********************************************************************************************************/
/*********************************************************************************************************
* 函数名称: main
* 函数功能: 主函数
* 输入参数: void
* 输出参数: void
* 返 回 值: void
* 创建日期: 
* 注    意: 
*********************************************************************************************************/

int main() {
    InitSoftware();

    timeSetEvent(2, 1, TimeProc, 0, TIME_PERIODIC);

    while(1) {
    }
}
